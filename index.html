<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BTC RECOVERY AI - V3 FIX</title>
    <style>
        body { background: #0b0e11; color: white; font-family: sans-serif; text-align: center; padding: 10px; }
        .card { border: 2px solid #f3ba2f; border-radius: 15px; padding: 15px; background: #1e2329; box-shadow: 0 0 20px rgba(243, 186, 47, 0.2); }
        .price { font-size: 40px; font-weight: bold; color: #f3ba2f; margin: 10px 0; }
        .info { font-size: 13px; color: #848e9c; margin-bottom: 10px; line-height: 1.6; }
        .log-box { text-align: left; background: #000; padding: 10px; height: 180px; overflow-y: auto; font-size: 11px; color: #00ff88; border: 1px solid #333; margin-top: 10px; }
        button { width: 100%; padding: 18px; background: #f3ba2f; color: black; font-weight: bold; border-radius: 10px; border: none; font-size: 20px; cursor: pointer; }
        .win { color: #00ff88; font-weight: bold; } .loss { color: #ff4d4d; font-weight: bold; }
    </style>
</head>
<body>
    <div class="card">
        <div style="font-size: 12px; color: #00ff88; font-weight: bold;">üíé BTC AI V3 - FIX TP/SL & AUTO SYNC</div>
        <div id="btcPrice" class="price">0.00</div>
        <div id="statusInfo" class="info">M1: -- | M5: -- | Sync Offset: 0<br>EMA9: -- | L·ªãch s·ª≠: 0 l·ªánh</div>
        <div id="logs" class="log-box">> H·ªá th·ªëng ƒëang ch·ªù k√≠ch ho·∫°t...</div>
        <button onclick="startVipBot()">K√çCH HO·∫†T H·ªÜ TH·ªêNG</button>
    </div>

    <script>
        const TOKEN = "8586899878:AAHONzWJqzUMswUPMjn5xaWvYrwDHSH4OYE";
        const CHAT_ID = "7994694689";
        let lastAction = "", lastUpdateId = 0;
        let rsiBuy = 40, rsiSell = 60, priceOffset = -80; 
        let currentPrice = 0, currentRsi = 0, currentEma = 0, currentRsiM5 = 0;
        let tradeHistory = []; 
        const audio = new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3');

        async function startVipBot() {
            document.getElementById('logs').innerHTML = "> Bot ƒë√£ ch·∫°y. ƒêang qu√©t t√≠n hi·ªáu...";
            setInterval(updateData, 2000); 
            setInterval(checkTele, 1500); // TƒÉng t·ªëc ƒë·ªô check l·ªánh Tele
            sendTele("üöÄ BOT V3 READY!\n- /tp : L∆∞u th·∫Øng\n- /sl : L∆∞u thua\n- /sync [gi√° MT5] : T·ª± kh·ªõp gi√° chu·∫©n\n- /history : Xem l·ªãch s·ª≠ g·ª° n·ª£");
        }

        async function updateData() {
            try {
                const r = await fetch(`https://api.binance.com/api/v3/klines?symbol=BTCUSDT&interval=1m&limit=100`);
                const d = await r.json();
                const prices = d.map(x => parseFloat(x[4]));
                currentPrice = prices[prices.length - 1];

                // T√≠nh RSI M1
                let g = 0, l = 0;
                for (let i = prices.length - 14; i < prices.length; i++) {
                    let diff = prices[i] - prices[i-1];
                    if (diff >= 0) g += diff; else l -= diff;
                }
                currentRsi = 100 - (100 / (1 + (g / l)));

                // T√≠nh EMA 9
                const k = 2 / (9 + 1);
                let ema = prices[0];
                for (let i = 1; i < prices.length; i++) { ema = (prices[i] * k) + (ema * (1 - k)); }
                currentEma = ema;

                document.getElementById('btcPrice').innerText = (currentPrice + priceOffset).toFixed(2);
                document.getElementById('statusInfo').innerHTML = `M1: ${currentRsi.toFixed(2)} | EMA9: ${currentEma.toFixed(2)} | Offset: ${priceOffset.toFixed(2)}<br>L·ªãch s·ª≠: ${tradeHistory.length} l·ªánh`;

                // Logic b√°o k√®o
                if (currentRsi <= rsiBuy && currentPrice > currentEma && lastAction !== "BUY") {
                    sendTele(`üíé [BUY NOW]\nüìç Entry: ${(currentPrice + priceOffset).toFixed(2)}\nüìä RSI: ${currentRsi.toFixed(2)}`);
                    lastAction = "BUY";
                    addLog("Ph√°t hi·ªán ƒëi·ªÉm BUY t·ªët!");
                }
                if (currentRsi >= rsiSell && currentPrice < currentEma && lastAction !== "SELL") {
                    sendTele(`üíé [SELL NOW]\nüìç Entry: ${(currentPrice + priceOffset).toFixed(2)}\nüìä RSI: ${currentRsi.toFixed(2)}`);
                    lastAction = "SELL";
                    addLog("Ph√°t hi·ªán ƒëi·ªÉm SELL t·ªët!");
                }
            } catch (e) {}
        }

        async function checkTele() {
            try {
                const r = await fetch(`https://api.telegram.org/bot${TOKEN}/getUpdates?offset=${lastUpdateId + 1}&timeout=1`);
                const d = await r.json();
                if (d.result && d.result.length > 0) {
                    for (let u of d.result) {
                        lastUpdateId = u.update_id;
                        if (!u.message || !u.message.text) continue;
                        const m = u.message.text.trim().toLowerCase();

                        // S·ª≠a l·ªói nh·∫≠n l·ªánh TP/SL
                        if (m === "/tp") {
                            const data = { type: lastAction || "K√®o", result: "TP", time: new Date().toLocaleTimeString() };
                            tradeHistory.push(data);
                            lastAction = ""; 
                            sendTele("‚úÖ CH√öC M·ª™NG! ƒê√£ ch·ªët l√£i v√† l∆∞u l·ªãch s·ª≠.");
                            addLog("L·ªánh TH·∫ÆNG ƒë√£ ƒë∆∞·ª£c ghi nh·∫≠n", "win");
                        } 
                        else if (m === "/sl") {
                            const data = { type: lastAction || "K√®o", result: "SL", time: new Date().toLocaleTimeString() };
                            tradeHistory.push(data);
                            lastAction = "";
                            sendTele("‚ùå ƒê√É SL. Bot ƒëang ph√¢n t√≠ch l·∫°i ƒë·ªÉ g·ª° n·ª£.");
                            addLog("L·ªánh THUA ƒë√£ ƒë∆∞·ª£c ghi nh·∫≠n", "loss");
                        }
                        else if (m.startsWith("/sync")) {
                            let mt5Price = parseFloat(m.split(" ")[1]);
                            if (mt5Price) {
                                priceOffset = mt5Price - currentPrice;
                                sendTele(`üéØ ƒê√£ ƒë·ªìng b·ªô! Offset m·ªõi: ${priceOffset.toFixed(2)}`);
                            }
                        }
                        else if (m === "/history") {
                            let txt = tradeHistory.map(t => `${t.time}: ${t.result} (${t.type})`).join("\n");
                            sendTele(`üìú L·ªäCH S·ª¨ G·ª† N·ª¢:\n${txt || "Ch∆∞a c√≥ d·ªØ li·ªáu"}`);
                        }
                    }
                }
            } catch (e) {}
        }

        function addLog(msg, className = "") {
            const l = document.getElementById('logs');
            l.innerHTML += `<br><span class="${className}">> ${msg}</span>`;
            l.scrollTop = l.scrollHeight;
        }

        function sendTele(m) { fetch(`https://api.telegram.org/bot${TOKEN}/sendMessage?chat_id=${CHAT_ID}&text=${encodeURIComponent(m)}`); }
    </script>
</body>
</html>
